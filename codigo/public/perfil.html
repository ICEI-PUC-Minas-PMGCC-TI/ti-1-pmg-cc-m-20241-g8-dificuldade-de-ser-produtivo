<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trackle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="assets/js/validateUser.js"></script>
</head>

<body>
    <nav>
        <div class="nav-group">
            <a href="inicio.html" class="nav-item" id="nav-home">
                <i class=" fa-solid fa-house"></i>
                <span>Início</span>
            </a>
            <a class="nav-item" id="nav-calendar">
                <i class="fa-solid fa-calendar-days"></i>
                <span>Agenda</span>
            </a>
            <a href="tarefas.html" class="nav-item" id="nav-tasks">
                <i class="fa-solid fa-list-check"></i>
                <span>Tarefas</span>
            </a>
            <a href="forum.html" class="nav-item" id="nav-forum">
                <i class="fa-solid fa-comments"></i>
                <span>Fórum</span>
            </a>
        </div>

        <div class="nav-group">
            <a href="" id="nav-profile">
                <div>
                    <i class="fa-solid fa-user"></i>
                </div>
            </a>

            <div class="nav-item" id="nav-logout">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Sair</span>
            </div>
        </div>
    </nav>

    <main id="perfil">
        <header class="banner-perfil">
            <div id="foto-nome-perfil">
                <img id="img-perfil" class="foto-perfil" src="assets/imgs/user.svg" />
                <h2 class="nome-perfil" id="Nome_Do_Perfil">Nome de Usuario</h2>
            </div>
        </header>
        <div class="corpo-perfil">
            <div class="nivel-perfil">
                <h3>Nível <span id="nivel-perfil"></span></h3>

                <div class="barra-xp-container">
                    <div class="barra-xp">
                        <div class="barra-xp2"></div>
                    </div>
                    <span class="progresso-xp"><span id="xp-atual"></span>/1000 XP</span>
                </div>
            </div>
            <section>
                <article class="sobre-mim">
                    <h1>Sobre Mim:</h1>
                    <p id="sobre-mim-texto">Nada informado.</p>
                </article>

                <article class="medalhas-perfil">
                    <h1>Medalhas:</h1>
                    <div class="medalhas-area">
                        <div class="medalhas-container" id="medalhas-container">
                        </div>
                    </div>
                </article>
            </section>
        </div>
    </main>

    <script>
        async function fetchTasks()
        {
            try
            {
                const response = await fetch('http://localhost:3000/tasks');
                const data = await response.json();

                return data;
            } catch (error)
            {
                console.error('Erro ao buscar tarefas:', error);
                return [];
            }
        }

        function contarTarefasCompletas(tasks)
        {
            return tasks.reduce((count, task) => count + (task.complete ? 1 : 0), 0);
        }


        async function updateExperience(userId, xpToAdd, level)
        {
            try
            {
                const response = await fetch(`http://localhost:3000/users/${userId}`, {
                    method: 'PATCH', // Ou POST, dependendo da sua API
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        level: level,
                        experience: xpToAdd
                    })
                });
                if (!response.ok)
                {
                    throw new Error('Erro ao atualizar a experiência do usuário');
                }
                const data = await response.json();
                console.log('Experiência atualizada:', data);
            } catch (error)
            {
                console.error('Erro ao atualizar a experiência do usuário:', error);
            }
        }
        function exibirMedalhas(completeTasksCount)
        {
            const medalhasContainer = document.getElementById('medalhas-container');
            medalhasContainer.innerHTML = ''; // Limpar o conteúdo anterior
            const medalhasCount = Math.floor(completeTasksCount / 2);

            const xpGained = medalhasCount * 200;

            // Atualiza o XP atual e verifica se houve upgrade de nível
            const xpAtualElement = document.getElementById('xp-atual');
            let xpAtual = xpAtualElement.textContent;
            xpAtual += xpGained;
            console.log(xpAtual);
            xpAtualElement.textContent = xpAtual;

            // Verifica se atingiu ou ultrapassou 1000 XP
            if (xpAtual >= 1000)
            {
                // Calcula o novo nível
                const nivelElement = document.getElementById('nivel-perfil');
                let nivel = nivelElement.textContent;


                nivel = Number(xpAtual) / 1000;
                nivelElement.textContent = Number(Math.trunc(nivel));

                // Zera o XP
                xpAtual = xpAtual % 1000;
                xpAtualElement.textContent = xpAtual;

                // Atualiza a barra de XP visualmente
                const barraXP = document.querySelector('.barra-xp2');
                barraXP.style.width = '0%'; // Zera a largura da barra

                console.log('nivel', nivel)
                updateExperience('ce16a42f-7fca-4162-bfab-da9a7759c9d9', xpAtual, Number(Math.trunc(nivel)));
            } else
            {
                // Atualiza a barra de XP visualmente (exemplo: aumentando a largura)
                const novaLargura = (xpAtual % 1000) / 10 + '%'; // Ajuste para a largura da barra
                const barraXP = document.querySelector('.barra-xp2');
                barraXP.style.width = novaLargura;

                console.log('nivel', nivel)
                updateExperience('ce16a42f-7fca-4162-bfab-da9a7759c9d9', xpAtual, Number(Math.trunc(nivel)));
            }

            // Exibe as medalhas
            for (let i = 0; i < medalhasCount; i++)
            {
                const medalhaElement = document.createElement('div');
                medalhaElement.className = 'medalha';
                medalhaElement.innerHTML = `
            <i class="fa-solid fa-medal"></i>
            <h3>Medalha</h3>
        `;
                medalhasContainer.appendChild(medalhaElement);
            }
        }

        async function init()
        {
            const tasks = await fetchTasks();
            const completeTasksCount = contarTarefasCompletas(tasks);
            exibirMedalhas(completeTasksCount);
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
    <script src="assets/js/jquery-3.7.1.min.js"></script>
    <script type="module" src="assets/js/profile/pages/profile.js"></script>
</body>

</html>